# Longbridge 自动买卖功能使用指南

## 概述

本系统是基于 Longbridge OpenAPI 的量化交易平台，支持多种技术指标策略的自动交易。系统包含实时行情订阅、策略引擎、风险管理、实时通知等完整功能。

## 功能特性

### 🤖 自动交易策略
- **均线交叉策略**: 基于短期和长期移动平均线交叉信号
- **RSI超卖反弹策略**: RSI指标超卖时买入，超买时卖出
- **突破策略**: 价格突破关键阻力位的动量策略
- **布林带策略**: 基于布林带的均值回归策略
- **MACD背离策略**: MACD指标背离信号的趋势反转策略

### 🛡️ 风险管理
- 自动止损/止盈
- 仓位大小控制
- 每日交易次数限制
- 策略冷却期
- 追踪止损

### 📊 实时监控
- 实时K线数据处理
- WebSocket推送交易信号
- 持仓实时监控
- 策略执行状态追踪

### 🔔 智能通知
- 交易信号推送
- 订单状态更新
- 风险预警
- 系统状态通知

## 安装和启动

### 方法1: 使用启动脚本 (推荐)

```bash
# 克隆项目后，直接运行启动脚本
cd longbridge
python start_trading.py
```

脚本会自动：
- 检查Python版本和依赖
- 安装前后端依赖
- 启动后端和前端服务
- 验证系统状态

### 方法2: 手动启动

#### 后端启动
```bash
cd backend
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -e .
pip install longport
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

#### 前端启动
```bash
cd frontend
npm install
npm run dev
```

## 配置说明

### 1. Longbridge API 凭据配置

在前端设置页面或通过环境变量配置：

```bash
export LONGPORT_APP_KEY="你的APP_KEY"
export LONGPORT_APP_SECRET="你的APP_SECRET"
export LONGPORT_ACCESS_TOKEN="你的ACCESS_TOKEN"
```

### 2. 股票代码配置

在设置页面添加要监控的股票代码：
- 港股格式: 0700.HK, 0005.HK
- 美股格式: AAPL.US, TSLA.US

### 3. 策略配置

策略配置文件位于 `config/strategies.json`，包含：

```json
{
  "strategies": [...],
  "global_settings": {
    "max_daily_trades": 10,        // 每日最大交易次数
    "cooldown_period": 300,        // 策略冷却期(秒)
    "max_risk_per_trade": 0.02,    // 单笔交易最大风险
    "order_type": "limit"          // 订单类型
  },
  "notification_settings": {
    "enabled": true,
    "channels": ["websocket", "log"],
    "events": [
      "order_placed",
      "order_filled",
      "stop_loss_triggered"
    ]
  }
}
```

## 使用流程

### 1. 初始设置
1. 访问 http://localhost:5173
2. 在设置页面配置 Longbridge 凭据
3. 添加要监控的股票代码
4. 测试API连接

### 2. 策略管理
1. 进入"策略控制中心"
2. 查看预配置的策略
3. 根据需要启用/禁用策略
4. 调整策略参数（监控标的）

### 3. 实时监控
1. 观察策略状态变化
2. 监控当前持仓
3. 查看交易通知
4. 检查系统日志

### 4. 风险控制
- 系统自动执行止损/止盈
- 监控每日交易次数限制
- 观察账户余额变化
- 及时调整策略参数

## 策略详解

### 均线交叉策略
**适用场景**: 趋势明确的市场
**信号逻辑**: 短期均线向上穿越长期均线时买入，向下穿越时卖出
**参数设置**:
- `short_period`: 短期均线周期 (默认5)
- `long_period`: 长期均线周期 (默认20)
- `volume_multiplier`: 成交量放大倍数 (默认1.5)

### RSI超卖反弹策略
**适用场景**: 震荡市场
**信号逻辑**: RSI < 30时买入，RSI > 70时卖出
**参数设置**:
- `rsi_period`: RSI计算周期 (默认14)
- `oversold`: 超卖阈值 (默认30)
- `overbought`: 超买阈值 (默认70)

### 突破策略
**适用场景**: 高波动性股票
**信号逻辑**: 价格突破历史高点且伴随大成交量时买入
**参数设置**:
- `breakout_period`: 突破判断周期 (默认20)
- `confirmation_bars`: 确认K线数量 (默认2)
- `volume_multiplier`: 成交量放大倍数 (默认2.0)

### 布林带策略
**适用场景**: 均值回归市场
**信号逻辑**: 价格触及下轨时买入，触及上轨时卖出
**参数设置**:
- `bollinger_period`: 布林带周期 (默认20)
- `std_deviation`: 标准差倍数 (默认2)

### MACD背离策略
**适用场景**: 趋势反转判断
**信号逻辑**: MACD金叉时买入，死叉时卖出
**参数设置**:
- `fast_period`: 快线周期 (默认12)
- `slow_period`: 慢线周期 (默认26)
- `signal_period`: 信号线周期 (默认9)

## 风险控制参数

### 全局设置
- `max_daily_trades`: 限制每日交易次数，防止过度交易
- `cooldown_period`: 策略冷却期，避免频繁触发
- `max_risk_per_trade`: 单笔交易最大风险比例

### 策略级设置
- `stop_loss`: 止损比例 (如 0.05 = 5%)
- `take_profit`: 止盈比例 (如 0.15 = 15%)
- `position_size`: 仓位大小比例 (如 0.1 = 10%)
- `max_positions`: 最大持仓数量
- `trailing_stop`: 追踪止损比例 (可选)

## 系统架构

### 后端服务 (FastAPI)
- **API路由**: `/strategies`, `/portfolio`, `/quotes`, `/notifications`
- **实时服务**: WebSocket推送 (`/ws/quotes`, `/strategies/ws`, `/notifications/ws`)
- **数据存储**: DuckDB本地数据库
- **安全加密**: Fernet加密存储敏感信息

### 前端界面 (React + TypeScript)
- **策略控制中心**: 策略管理和监控
- **实时图表**: K线图和技术指标显示
- **设置页面**: API凭据和股票代码配置
- **持仓监控**: 实时持仓和盈亏显示

### 核心模块
- **策略引擎** (`strategy_engine.py`): 技术指标计算和信号生成
- **交易API** (`trading_api.py`): Longbridge API集成
- **流式数据** (`streaming.py`): 实时行情订阅
- **通知系统** (`notification_manager.py`): 实时事件推送

## 监控和调试

### 日志查看
```bash
# 后端日志
tail -f backend/logs/app.log

# 策略执行日志
tail -f backend/logs/strategy.log
```

### 关键监控指标
1. **系统状态**: WebSocket连接状态，API响应时间
2. **策略状态**: 各策略运行状态和最后执行时间
3. **交易指标**: 今日交易次数，持仓数量，盈亏情况
4. **风险指标**: 止损触发次数，最大回撤，夏普比率

### 常见问题排查
1. **API连接失败**: 检查凭据配置和网络连接
2. **策略不触发**: 确认策略已启用且数据订阅正常
3. **订单失败**: 检查账户余额和股票可交易性
4. **实时数据中断**: 重启行情订阅服务

## 注意事项

### ⚠️ 重要提醒
1. **资金安全**: 建议先用少量资金测试策略有效性
2. **市场风险**: 所有投资都有风险，请谨慎操作
3. **合规要求**: 确保符合所在地区的交易法规
4. **系统稳定性**: 保持网络连接稳定，定期检查系统状态

### 💡 最佳实践
1. **回测验证**: 新策略上线前充分回测
2. **分散投资**: 不要将所有资金投入单一策略
3. **风险控制**: 设置合理的止损和仓位大小
4. **定期优化**: 根据市场变化调整策略参数
5. **日志分析**: 定期分析交易记录，持续改进

## 技术支持

如遇问题，请检查：
1. 系统日志和错误信息
2. Longbridge API连接状态
3. 策略配置文件格式
4. 网络连接和防火墙设置

## 更新日志

### v1.0.0
- 完整的自动交易系统
- 5种预置策略
- 实时行情和通知
- Web界面管理
- 风险控制机制