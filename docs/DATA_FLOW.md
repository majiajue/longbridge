# æ•°æ®æµä¸è®¿é—®è·¯å¾„è¯¦è§£

## ğŸ“‹ ç›®å½•

- [æ•´ä½“æ•°æ®æµæ¶æ„](#æ•´ä½“æ•°æ®æµæ¶æ„)
- [å¤–éƒ¨æ•°æ®æµ](#å¤–éƒ¨æ•°æ®æµ)
- [å†…éƒ¨æ•°æ®æµ](#å†…éƒ¨æ•°æ®æµ)
- [æ•°æ®è®¿é—®è·¯å¾„](#æ•°æ®è®¿é—®è·¯å¾„)
- [å®æ—¶æ•°æ®æµ](#å®æ—¶æ•°æ®æµ)
- [äº¤æ˜“æ•°æ®æµ](#äº¤æ˜“æ•°æ®æµ)
- [é…ç½®æ•°æ®æµ](#é…ç½®æ•°æ®æµ)
- [ç¼“å­˜ç­–ç•¥](#ç¼“å­˜ç­–ç•¥)

---

## æ•´ä½“æ•°æ®æµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å¤–éƒ¨æ•°æ®æº                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Longbridge           â”‚        â”‚ Longbridge           â”‚          â”‚
â”‚  â”‚ QuoteContext         â”‚        â”‚ TradeContext         â”‚          â”‚
â”‚  â”‚ (è¡Œæƒ… API)            â”‚        â”‚ (äº¤æ˜“ API)            â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ WebSocket                    â†“ HTTP/gRPC
           â†“ (å®æ—¶æ¨é€)                     â†“ (è¯·æ±‚/å“åº”)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®æ¥å…¥å±‚ (Backend)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ QuoteStreamManager   â”‚        â”‚ TradingAPI           â”‚          â”‚
â”‚  â”‚ (streaming.py)       â”‚        â”‚ (trading_api.py)     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                                â†“
           â†“ (å½’ä¸€åŒ–ã€æ´¾å‘)                    â†“ (å°è£…ã€è½¬æ¢)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ ¸å¿ƒå¤„ç†å±‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Strategy    â”‚ Position    â”‚ Notificationâ”‚ Services     â”‚        â”‚
â”‚  â”‚ Engine      â”‚ Monitor     â”‚ Manager     â”‚ (ä¸šåŠ¡é€»è¾‘)    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                                â†“
           â†“ (è¯»å†™)                          â†“ (æŸ¥è¯¢ã€å­˜å‚¨)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®æŒä¹…åŒ–å±‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Repositories         â”‚   â†’    â”‚ DuckDB               â”‚          â”‚
â”‚  â”‚ (repositories.py)    â”‚        â”‚ (data/quant.db)      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘                                â†‘
           â†‘ HTTP API                       â†‘ WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API æš´éœ²å±‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ FastAPI Routers                                        â”‚        â”‚
â”‚  â”‚ (settings/quotes/portfolio/strategies/monitoring)      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘                                â†‘
           â†‘ HTTP/WebSocket                 â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚ (React)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ API Client           â”‚        â”‚ WebSocket Client     â”‚          â”‚
â”‚  â”‚ (client.ts)          â”‚        â”‚ (å„é¡µé¢ç»„ä»¶)          â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¤–éƒ¨æ•°æ®æµ

### 1. è¡Œæƒ…æ•°æ®æµï¼ˆLongbridge â†’ ç³»ç»Ÿï¼‰

```
Longbridge æœåŠ¡å™¨
    â†“
[WebSocket è¿æ¥]
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QuoteStreamManager._subscription_loop()      â”‚
â”‚ (è¿è¡Œåœ¨ç‹¬ç«‹çº¿ç¨‹)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
[QuoteContext.subscribe()]
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QuoteStreamManager._on_quote()               â”‚
â”‚ - æ¥æ”¶åŸå§‹ QuoteEvent                         â”‚
â”‚ - å½’ä¸€åŒ–æ•°æ®æ ¼å¼                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
[æ•°æ®æ´¾å‘åˆ° 4 ä¸ªç›®æ ‡]
    â†“
    â”œâ”€â†’ [1] WebSocket å®¢æˆ·ç«¯ï¼ˆå‰ç«¯å®æ—¶å±•ç¤ºï¼‰
    â”‚       QuoteStreamManager._broadcast()
    â”‚           â†“
    â”‚       å‰ç«¯ WebSocket è¿æ¥
    â”‚           â†“
    â”‚       é¡µé¢ç»„ä»¶æ›´æ–°
    â”‚
    â”œâ”€â†’ [2] StrategyEngineï¼ˆç­–ç•¥è¯„ä¼°ï¼‰
    â”‚       StrategyEngine.process_kline()
    â”‚           â†“
    â”‚       æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
    â”‚           â†“
    â”‚       ä¹°å–æ¡ä»¶è¯„ä¼°
    â”‚           â†“
    â”‚       äº¤æ˜“å†³ç­–ï¼ˆå¦‚è§¦å‘ï¼‰
    â”‚
    â”œâ”€â†’ [3] PositionMonitorï¼ˆä»“ä½ç›‘æ§ï¼‰
    â”‚       PositionMonitor.process_quote()
    â”‚           â†“
    â”‚       æ›´æ–°æŒä»“ç›ˆäº
    â”‚           â†“
    â”‚       æ£€æŸ¥æ­¢æŸ/æ­¢ç›ˆ
    â”‚           â†“
    â”‚       é£é™©ç®¡ç†æ£€æŸ¥
    â”‚
    â””â”€â†’ [4] Repositoriesï¼ˆæ•°æ®æŒä¹…åŒ–ï¼‰
            store_tick_event()
                â†“
            INSERT INTO ticks
                â†“
            DuckDB å­˜å‚¨
```

**æ•°æ®æµç‰¹ç‚¹**ï¼š
- **å®æ—¶æ€§**ï¼šWebSocket æ¨é€ï¼Œå»¶è¿Ÿ < 100ms
- **å¹¶å‘å¤„ç†**ï¼šåŒæ—¶æ´¾å‘åˆ° 4 ä¸ªç›®æ ‡
- **çº¿ç¨‹éš”ç¦»**ï¼šè®¢é˜…å¾ªç¯åœ¨ç‹¬ç«‹çº¿ç¨‹ï¼Œä¸é˜»å¡ä¸»äº‹ä»¶å¾ªç¯
- **é”™è¯¯éš”ç¦»**ï¼šå•ä¸ªæ´¾å‘ç›®æ ‡å¤±è´¥ä¸å½±å“å…¶ä»–ç›®æ ‡

### 2. äº¤æ˜“æ•°æ®æµï¼ˆç³»ç»Ÿ â†’ Longbridgeï¼‰

```
ç­–ç•¥å¼•æ“è§¦å‘äº¤æ˜“ä¿¡å·
    â†“
StrategyEngine.execute_optimal_buy()
    â†“
åˆ›å»º OrderRequest å¯¹è±¡
    â†“
TradingAPI.place_order(order_request)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TradingAPI._get_trade_context()              â”‚
â”‚ - åŠ è½½å‡­æ®                                    â”‚
â”‚ - åˆ›å»º TradeContext                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
[TradeContext.submit_order()]
    â†“
Longbridge æœåŠ¡å™¨
    â†“
[è®¢å•æ‰§è¡Œã€æˆäº¤]
    â†“
è¿”å› OrderResponse
    â†“
TradingAPI å¤„ç†å“åº”
    â†“
    â”œâ”€â†’ æ›´æ–° Position å¯¹è±¡ï¼ˆorder_idã€æˆäº¤ä»·ç­‰ï¼‰
    â”‚
    â”œâ”€â†’ NotificationManager å‘é€é€šçŸ¥
    â”‚       â†“
    â”‚   WebSocket æ¨é€åˆ°å‰ç«¯
    â”‚       â†“
    â”‚   å‰ç«¯æ˜¾ç¤ºé€šçŸ¥
    â”‚
    â””â”€â†’ StrategyEngine æ›´æ–°çŠ¶æ€
            â†“
        daily_trade_count++
        last_trade_time æ›´æ–°
```

**æ•°æ®æµç‰¹ç‚¹**ï¼š
- **åŒæ­¥è°ƒç”¨**ï¼šç­‰å¾… Longbridge å“åº”
- **è¶…æ—¶å¤„ç†**ï¼šè®¾ç½®åˆç†è¶…æ—¶æ—¶é—´
- **é‡è¯•æœºåˆ¶**ï¼šAPI å±‚å¯å®ç°é‡è¯•ï¼ˆå½“å‰æœªå®ç°ï¼‰
- **çŠ¶æ€è¿½è¸ª**ï¼šè®¢å• ID ä¸ Position å…³è”

### 3. è´¦æˆ·æ•°æ®æŸ¥è¯¢ï¼ˆç³»ç»Ÿ â†’ Longbridge â†’ ç³»ç»Ÿï¼‰

```
å‰ç«¯è¯·æ±‚ç»„åˆæ¦‚è§ˆ
    â†“
GET /portfolio/overview
    â†“
routers/portfolio.py
    â†“
services.get_portfolio_overview()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼˜å…ˆè¯»å–ç¼“å­˜ï¼ˆå†…å­˜ K çº¿ç¼“å†²åŒºï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
[ç¼“å­˜æœªå‘½ä¸­æˆ–æ•°æ®è¿‡æœŸ]
    â†“
TradingAPI.get_positions()
TradingAPI.get_account_balance()
    â†“
TradeContext.stock_positions()
TradeContext.account_balance()
    â†“
Longbridge æœåŠ¡å™¨
    â†“
[è¿”å›æŒä»“ä¸èµ„é‡‘æ•°æ®]
    â†“
TradingAPI å½’ä¸€åŒ–æ•°æ®
    â†“
services å±‚ç»„è£…å“åº”
    â†“
    â”œâ”€â†’ è®¡ç®—æœ€æ–°ä»·æ ¼ï¼ˆä» DuckDB ticks è¡¨ï¼‰
    â”‚
    â”œâ”€â†’ è®¡ç®—ç›ˆäºï¼ˆå½“å‰ä»· - æˆæœ¬ä»·ï¼‰
    â”‚
    â””â”€â†’ æ±‡æ€»æ€»å€¼
    â†“
è¿”å› JSON ç»™å‰ç«¯
    â†“
å‰ç«¯é¡µé¢å±•ç¤º
```

---

## å†…éƒ¨æ•°æ®æµ

### 1. é…ç½®æ•°æ®æµ

#### å‡­æ®é…ç½®æµç¨‹

```
å‰ç«¯è®¾ç½®é¡µé¢
    â†“
ç”¨æˆ·è¾“å…¥å‡­æ®ï¼ˆAPP_KEYã€SECRETã€TOKENï¼‰
    â†“
PUT /settings/credentials
    â†“
routers/settings.py
    â†“
repositories.save_credentials(creds)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è·å– Fernet åŠ å¯†å®ä¾‹                       â”‚
â”‚    config.get_settings().get_fernet()        â”‚
â”‚                                              â”‚
â”‚ 2. åŠ å¯†æ¯ä¸ªå‡­æ®                               â”‚
â”‚    token = fernet.encrypt(value.encode())    â”‚
â”‚                                              â”‚
â”‚ 3. å­˜å‚¨åˆ°æ•°æ®åº“                               â”‚
â”‚    INSERT INTO settings (key, value)         â”‚
â”‚    VALUES ('longport_app_key', encrypted)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
DuckDB æŒä¹…åŒ–
    â†“
[è§¦å‘è¡Œæƒ…æµé‡å¯]
    â†“
QuoteStreamManager.restart()
    â†“
é‡æ–°åŠ è½½å‡­æ® â†’ é‡æ–°è®¢é˜…
```

#### ç­–ç•¥é…ç½®æµç¨‹

```
ä¿®æ”¹ config/strategies.json
    â†“
POST /strategies/reload
    â†“
routers/strategies.py
    â†“
StrategyEngine.reload_strategies()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¯»å– JSON æ–‡ä»¶                             â”‚
â”‚    json.load(strategies.json)                â”‚
â”‚                                              â”‚
â”‚ 2. è§£æç­–ç•¥é…ç½®                               â”‚
â”‚    strategies = {s['id']: s for s in ...}    â”‚
â”‚                                              â”‚
â”‚ 3. åˆå§‹åŒ–ç­–ç•¥çŠ¶æ€                             â”‚
â”‚    strategy_status[id] = IDLE               â”‚
â”‚                                              â”‚
â”‚ 4. åº”ç”¨å…¨å±€è®¾ç½®                               â”‚
â”‚    global_settings = config['global_...']    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç­–ç•¥å¼•æ“å°±ç»ª
    â†“
å¼€å§‹è¯„ä¼°æ–°çš„ç­–ç•¥æ¡ä»¶
```

### 2. å†å²æ•°æ®åŒæ­¥æµç¨‹

```
å‰ç«¯è®¾ç½®é¡µé¢ç‚¹å‡»"åŒæ­¥å†å²æ•°æ®"
    â†“
POST /quotes/history/sync
    â†“
routers/quotes.py
    â†“
services.sync_candlesticks(symbols, period, adjust_type, count)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¯¹æ¯ä¸ª symbol æ‰§è¡Œï¼š                          â”‚
â”‚                                              â”‚
â”‚ 1. åˆ›å»º QuoteContext                         â”‚
â”‚    ctx = _quote_context()                   â”‚
â”‚                                              â”‚
â”‚ 2. è°ƒç”¨ Longbridge API                       â”‚
â”‚    candlesticks = ctx.history_candlesticks  â”‚
â”‚                  _by_offset(...)            â”‚
â”‚                                              â”‚
â”‚ 3. è½¬æ¢ä¸ºå†…éƒ¨æ ¼å¼                             â”‚
â”‚    [Candlestick] â†’ [dict]                   â”‚
â”‚                                              â”‚
â”‚ 4. æ‰¹é‡å†™å…¥æ•°æ®åº“                             â”‚
â”‚    repositories.store_candlesticks(...)     â”‚
â”‚        â†“                                     â”‚
â”‚    INSERT OR REPLACE INTO ohlc              â”‚
â”‚                                              â”‚
â”‚ 5. å…³é—­ä¸Šä¸‹æ–‡                                 â”‚
â”‚    ctx.close()                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›åŒæ­¥ç»Ÿè®¡ {symbol: count}
    â†“
å‰ç«¯æ˜¾ç¤ºåŒæ­¥ç»“æœ
```

**æ‰¹é‡å†™å…¥ä¼˜åŒ–**ï¼š
```python
# repositories.py
with get_connection() as conn:
    conn.executemany(
        "INSERT OR REPLACE INTO ohlc (...) VALUES (...)",
        records  # æ‰¹é‡æ’å…¥ï¼Œé¿å…é€æ¡å†™å…¥
    )
    conn.commit()  # æ˜¾å¼æäº¤äº‹åŠ¡
```

### 3. æŸ¥è¯¢æ•°æ®æµï¼ˆå¤šå±‚ç¼“å­˜ç­–ç•¥ï¼‰

```
å‰ç«¯è¯·æ±‚å†å² K çº¿
    â†“
GET /quotes/history?symbol=AAPL.US&limit=100
    â†“
routers/quotes.py
    â†“
services.get_cached_candlesticks(symbol, limit)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€ç¬¬ 1 å±‚ï¼šå†…å­˜ç¼“å­˜ã€‘                          â”‚
â”‚ æ£€æŸ¥ StrategyEngine.kline_buffers           â”‚
â”‚     â†“                                        â”‚
â”‚ if buffer.data è¶³å¤Ÿä¸”æ–°é²œ:                   â”‚
â”‚     return buffer.data[-limit:]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (ç¼“å­˜æœªå‘½ä¸­)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€ç¬¬ 2 å±‚ï¼šæ•°æ®åº“ç¼“å­˜ã€‘                        â”‚
â”‚ repositories.fetch_candlesticks(symbol, limit)â”‚
â”‚     â†“                                        â”‚
â”‚ SELECT * FROM ohlc                           â”‚
â”‚ WHERE symbol = ?                             â”‚
â”‚ ORDER BY ts DESC LIMIT ?                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (æœ‰æ•°æ®)
è¿”å› K çº¿æ•°æ®
    â†“
å‰ç«¯å›¾è¡¨å±•ç¤º
```

**å¦‚æœæ•°æ®åº“ä¹Ÿæ²¡æœ‰æ•°æ®**ï¼š
```
repositories.fetch_bars_from_ticks(symbol, limit)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€ç¬¬ 3 å±‚ï¼šTick èšåˆã€‘                         â”‚
â”‚ ä» ticks è¡¨èšåˆåˆ†é’Ÿçº¿                         â”‚
â”‚     â†“                                        â”‚
â”‚ WITH base AS (                               â”‚
â”‚     SELECT ts, price, volume FROM ticks      â”‚
â”‚     WHERE symbol = ?                         â”‚
â”‚ ),                                           â”‚
â”‚ g AS (                                       â”‚
â”‚     SELECT date_trunc('minute', ts) AS t,    â”‚
â”‚            first(price) AS open,             â”‚
â”‚            max(price) AS high,               â”‚
â”‚            min(price) AS low,                â”‚
â”‚            last(price) AS close,             â”‚
â”‚            sum(volume) AS volume             â”‚
â”‚     FROM base GROUP BY 1                     â”‚
â”‚     ORDER BY 1 DESC LIMIT ?                  â”‚
â”‚ )                                            â”‚
â”‚ SELECT * FROM g ORDER BY t DESC              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›èšåˆçš„ K çº¿
```

---

## æ•°æ®è®¿é—®è·¯å¾„

### è·¯å¾„ 1ï¼šå‰ç«¯ â†’ åç«¯ API â†’ æ•°æ®åº“

**ç¤ºä¾‹ï¼šæŸ¥è¯¢æŒä»“åˆ—è¡¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ (PositionMonitoring.tsx)                               â”‚
â”‚                                                             â”‚
â”‚ useEffect(() => {                                           â”‚
â”‚     fetchPositions();                                       â”‚
â”‚ }, []);                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ HTTP GET
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Client (client.ts)                                      â”‚
â”‚                                                             â”‚
â”‚ export async function fetchPositions() {                    â”‚
â”‚     const response = await fetch(                           â”‚
â”‚         `${API_BASE}/portfolio/positions`                   â”‚
â”‚     );                                                      â”‚
â”‚     return handleResponse(response);                        â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ /portfolio/positions
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Router (routers/portfolio.py)                               â”‚
â”‚                                                             â”‚
â”‚ @router.get("/positions")                                   â”‚
â”‚ async def get_positions():                                  â”‚
â”‚     try:                                                    â”‚
â”‚         positions = get_positions_with_monitoring()         â”‚
â”‚         return positions                                    â”‚
â”‚     except Exception as e:                                  â”‚
â”‚         raise HTTPException(500, detail=str(e))             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service (services.py)                                       â”‚
â”‚                                                             â”‚
â”‚ def get_positions_with_monitoring():                        â”‚
â”‚     # ä» Longbridge API è·å–æŒä»“                            â”‚
â”‚     positions = _get_positions_from_api()                   â”‚
â”‚                                                             â”‚
â”‚     # ä» DuckDB è·å–ç›‘æ§é…ç½®                                â”‚
â”‚     for pos in positions:                                   â”‚
â”‚         config = get_position_monitoring_config(           â”‚
â”‚             pos['symbol']                                   â”‚
â”‚         )                                                   â”‚
â”‚         pos['monitoring_config'] = config                   â”‚
â”‚                                                             â”‚
â”‚     return positions                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TradingAPI          â”‚    â”‚ Repositories                     â”‚
â”‚                     â”‚    â”‚                                  â”‚
â”‚ get_positions()     â”‚    â”‚ get_position_monitoring_config() â”‚
â”‚     â†“               â”‚    â”‚     â†“                            â”‚
â”‚ Longbridge API      â”‚    â”‚ SELECT FROM position_monitoring  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â†“                            â”‚
                           â”‚ DuckDB                           â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç»„åˆæ•°æ®è¿”å›å‰ç«¯
```

### è·¯å¾„ 2ï¼šå®æ—¶æ•°æ® â†’ WebSocket â†’ å‰ç«¯

**ç¤ºä¾‹ï¼šå®æ—¶è¡Œæƒ…æ¨é€**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Longbridge QuoteContext (WebSocket æ¨é€)                    â”‚
â”‚                                                             â”‚
â”‚ quote_event: {                                              â”‚
â”‚     symbol: "AAPL.US",                                      â”‚
â”‚     timestamp: 1696358400,                                  â”‚
â”‚     last_done: 151.25,                                      â”‚
â”‚     volume: 1000000,                                        â”‚
â”‚     ...                                                     â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ callback
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QuoteStreamManager._on_quote(quote_event)                   â”‚
â”‚                                                             â”‚
â”‚ # 1. å½’ä¸€åŒ–æ•°æ®                                              â”‚
â”‚ normalized = {                                              â”‚
â”‚     "symbol": quote_event.symbol,                           â”‚
â”‚     "timestamp": datetime.fromtimestamp(...),               â”‚
â”‚     "last_done": float(quote_event.last_done),              â”‚
â”‚     ...                                                     â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â”‚ # 2. å¹¿æ’­åˆ° WebSocket å®¢æˆ·ç«¯                                â”‚
â”‚ await self._broadcast(normalized)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ WebSocket send
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FastAPI WebSocket Endpoint (/ws/quotes)                     â”‚
â”‚                                                             â”‚
â”‚ @app.websocket("/ws/quotes")                                â”‚
â”‚ async def websocket_quotes(websocket: WebSocket):           â”‚
â”‚     await websocket.accept()                                â”‚
â”‚     queue = quote_stream_manager.add_listener()             â”‚
â”‚                                                             â”‚
â”‚     while True:                                             â”‚
â”‚         quote = await queue.get()                           â”‚
â”‚         await websocket.send_json(quote)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ WebSocket message
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ WebSocket Client (RealtimeSimple.tsx)                  â”‚
â”‚                                                             â”‚
â”‚ const ws = new WebSocket(wsUrl);                            â”‚
â”‚                                                             â”‚
â”‚ ws.onmessage = (event) => {                                 â”‚
â”‚     const quote = JSON.parse(event.data);                   â”‚
â”‚     setQuotes(prev => ({                                    â”‚
â”‚         ...prev,                                            â”‚
â”‚         [quote.symbol]: quote                               â”‚
â”‚     }));                                                    â”‚
â”‚ };                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
UI æ›´æ–°æ˜¾ç¤ºæœ€æ–°è¡Œæƒ…
```

### è·¯å¾„ 3ï¼šç­–ç•¥å¼•æ“ â†’ äº¤æ˜“ API â†’ Longbridge

**ç¤ºä¾‹ï¼šè‡ªåŠ¨ä¸‹å•æµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¡Œæƒ…æ›´æ–°è§¦å‘                                                 â”‚
â”‚ QuoteStreamManager â†’ StrategyEngine.process_kline()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StrategyEngine.evaluate_strategy()                          â”‚
â”‚                                                             â”‚
â”‚ # 1. æ£€æŸ¥ K çº¿ç¼“å†²åŒº                                         â”‚
â”‚ buffer = self.kline_buffers[symbol]                         â”‚
â”‚ if len(buffer.data) < 50:                                   â”‚
â”‚     return  # æ•°æ®ä¸è¶³                                      â”‚
â”‚                                                             â”‚
â”‚ # 2. è®¡ç®—æŠ€æœ¯æŒ‡æ ‡                                            â”‚
â”‚ rsi = self.indicators.rsi(buffer.get_closes(14), 14)        â”‚
â”‚ ma_short = self.indicators.sma(buffer.get_closes(5), 5)     â”‚
â”‚ ma_long = self.indicators.sma(buffer.get_closes(20), 20)    â”‚
â”‚                                                             â”‚
â”‚ # 3. è¯„ä¼°ä¹°å…¥æ¡ä»¶                                            â”‚
â”‚ if self.evaluate_conditions(                                â”‚
â”‚     strategy['conditions']['buy'],                          â”‚
â”‚     buffer,                                                 â”‚
â”‚     market_data                                             â”‚
â”‚ ):                                                          â”‚
â”‚     # è§¦å‘ä¹°å…¥ä¿¡å·                                           â”‚
â”‚     await self.execute_optimal_buy(...)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ ä¹°å…¥ä¿¡å·è§¦å‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StrategyEngine.execute_optimal_buy()                        â”‚
â”‚                                                             â”‚
â”‚ # 1. é£é™©æ£€æŸ¥                                                â”‚
â”‚ if not self._check_risk_limits():                           â”‚
â”‚     return                                                  â”‚
â”‚                                                             â”‚
â”‚ # 2. åˆ›å»ºè®¢å•è¯·æ±‚                                            â”‚
â”‚ order_request = OrderRequest(                               â”‚
â”‚     symbol=symbol,                                          â”‚
â”‚     side=OrderSide.BUY,                                     â”‚
â”‚     quantity=quantity,                                      â”‚
â”‚     order_type=OrderType.MARKET                             â”‚
â”‚ )                                                           â”‚
â”‚                                                             â”‚
â”‚ # 3. è°ƒç”¨äº¤æ˜“ API                                            â”‚
â”‚ trading_api = get_trading_api()                             â”‚
â”‚ order_response = await trading_api.place_order(             â”‚
â”‚     order_request                                           â”‚
â”‚ )                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TradingAPI.place_order(order_request)                       â”‚
â”‚                                                             â”‚
â”‚ # 1. è·å– TradeContext                                       â”‚
â”‚ ctx = self._get_trade_context()                             â”‚
â”‚                                                             â”‚
â”‚ # 2. æäº¤è®¢å•åˆ° Longbridge                                   â”‚
â”‚ response = ctx.submit_order(                                â”‚
â”‚     symbol=order_request.symbol,                            â”‚
â”‚     order_type=LBOrderType.MO,  # å¸‚ä»·å•                    â”‚
â”‚     side=LBOrderSide.Buy,                                   â”‚
â”‚     submitted_quantity=order_request.quantity               â”‚
â”‚ )                                                           â”‚
â”‚                                                             â”‚
â”‚ # 3. è½¬æ¢å“åº”                                                â”‚
â”‚ return OrderResponse(                                       â”‚
â”‚     order_id=response.order_id,                             â”‚
â”‚     status=OrderStatus.SUBMITTED,                           â”‚
â”‚     ...                                                     â”‚
â”‚ )                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Longbridge æœåŠ¡å™¨                                            â”‚
â”‚ - éªŒè¯è®¢å•                                                   â”‚
â”‚ - æ‰§è¡Œäº¤æ˜“                                                   â”‚
â”‚ - è¿”å›è®¢å• ID                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç»­å¤„ç†                                                     â”‚
â”‚                                                             â”‚
â”‚ # 1. æ›´æ–°æŒä»“å¯¹è±¡                                            â”‚
â”‚ position.order_id = order_response.order_id                 â”‚
â”‚ position.status = "open"                                    â”‚
â”‚                                                             â”‚
â”‚ # 2. å‘é€é€šçŸ¥                                                â”‚
â”‚ await notification_manager.send_order_update(...)           â”‚
â”‚     â†“                                                       â”‚
â”‚ WebSocket æ¨é€åˆ°å‰ç«¯                                         â”‚
â”‚                                                             â”‚
â”‚ # 3. æ›´æ–°ç­–ç•¥çŠ¶æ€                                            â”‚
â”‚ self.daily_trade_count += 1                                 â”‚
â”‚ self.strategy_status[strategy_id] = EXECUTING               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®æ—¶æ•°æ®æµ

### è¡Œæƒ…è®¢é˜…ç”Ÿå‘½å‘¨æœŸ

```
ã€ç³»ç»Ÿå¯åŠ¨ã€‘
    â†“
main.py: @app.on_event("startup")
    â†“
quote_stream_manager.attach_loop(event_loop)
quote_stream_manager.ensure_started()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QuoteStreamManager.ensure_started()                         â”‚
â”‚                                                             â”‚
â”‚ if not self._thread or not self._thread.is_alive():         â”‚
â”‚     # åˆ›å»ºå¹¶å¯åŠ¨è®¢é˜…çº¿ç¨‹                                     â”‚
â”‚     self._thread = Thread(                                  â”‚
â”‚         target=self._subscription_loop,                     â”‚
â”‚         daemon=True                                         â”‚
â”‚     )                                                       â”‚
â”‚     self._thread.start()                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QuoteStreamManager._subscription_loop()                     â”‚
â”‚ (è¿è¡Œåœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­)                                           â”‚
â”‚                                                             â”‚
â”‚ while self._running:                                        â”‚
â”‚     try:                                                    â”‚
â”‚         # 1. åŠ è½½å‡­æ®                                        â”‚
â”‚         creds = load_credentials()                          â”‚
â”‚                                                             â”‚
â”‚         # 2. åˆ›å»º QuoteContext                              â”‚
â”‚         config = Config(...)                                â”‚
â”‚         ctx = QuoteContext(config)                          â”‚
â”‚                                                             â”‚
â”‚         # 3. è®¾ç½®å›è°ƒ                                        â”‚
â”‚         ctx.set_on_quote(self._on_quote)                    â”‚
â”‚                                                             â”‚
â”‚         # 4. è®¢é˜…è‚¡ç¥¨                                        â”‚
â”‚         symbols = load_symbols()                            â”‚
â”‚         ctx.subscribe(symbols, [SubType.Quote], True)       â”‚
â”‚                                                             â”‚
â”‚         # 5. é˜»å¡ç­‰å¾…ï¼ˆä¿æŒè¿æ¥ï¼‰                            â”‚
â”‚         while self._running:                                â”‚
â”‚             time.sleep(1)                                   â”‚
â”‚                                                             â”‚
â”‚     except Exception as e:                                  â”‚
â”‚         logger.error(f"Subscription error: {e}")            â”‚
â”‚         time.sleep(5)  # é‡è¿å»¶è¿Ÿ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ã€æŒç»­è¿è¡Œï¼Œæ¥æ”¶è¡Œæƒ…æ¨é€ã€‘
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QuoteStreamManager._on_quote(symbol, quote_event)           â”‚
â”‚ (å›è°ƒå‡½æ•°ï¼ŒLongbridge SDK è°ƒç”¨)                              â”‚
â”‚                                                             â”‚
â”‚ # 1. å½’ä¸€åŒ–æ•°æ®                                              â”‚
â”‚ normalized_quote = {                                        â”‚
â”‚     "symbol": symbol,                                       â”‚
â”‚     "timestamp": quote_event.timestamp,                     â”‚
â”‚     "last_done": quote_event.last_done,                     â”‚
â”‚     "open": quote_event.open,                               â”‚
â”‚     "high": quote_event.high,                               â”‚
â”‚     "low": quote_event.low,                                 â”‚
â”‚     "volume": quote_event.volume,                           â”‚
â”‚     "turnover": quote_event.turnover,                       â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â”‚ # 2. æ´¾å‘åˆ°å„ä¸ªå¤„ç†å™¨                                        â”‚
â”‚ asyncio.run_coroutine_threadsafe(                           â”‚
â”‚     self._dispatch(symbol, normalized_quote),               â”‚
â”‚     self._loop                                              â”‚
â”‚ )                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QuoteStreamManager._dispatch(symbol, quote)                 â”‚
â”‚ (è¿è¡Œåœ¨ä¸»äº‹ä»¶å¾ªç¯)                                           â”‚
â”‚                                                             â”‚
â”‚ # å¹¶å‘æ´¾å‘åˆ°æ‰€æœ‰ç›®æ ‡                                         â”‚
â”‚ await asyncio.gather(                                       â”‚
â”‚     self._broadcast(quote),              # WebSocket å®¢æˆ·ç«¯â”‚
â”‚     self._dispatch_to_strategy(quote),   # ç­–ç•¥å¼•æ“        â”‚
â”‚     self._dispatch_to_monitor(quote),    # ä»“ä½ç›‘æ§        â”‚
â”‚     self._persist_tick(quote),           # æ•°æ®æŒä¹…åŒ–      â”‚
â”‚     return_exceptions=True               # é”™è¯¯éš”ç¦»        â”‚
â”‚ )                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WebSocket è¿æ¥ç®¡ç†

```
å‰ç«¯å»ºç«‹ WebSocket è¿æ¥
    â†“
const ws = new WebSocket("ws://localhost:8000/ws/quotes")
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FastAPI WebSocket Endpoint                                  â”‚
â”‚                                                             â”‚
â”‚ @app.websocket("/ws/quotes")                                â”‚
â”‚ async def websocket_quotes(websocket: WebSocket):           â”‚
â”‚     # 1. æ¥å—è¿æ¥                                            â”‚
â”‚     await websocket.accept()                                â”‚
â”‚     logger.info("WebSocket client connected")               â”‚
â”‚                                                             â”‚
â”‚     # 2. æ³¨å†Œç›‘å¬å™¨                                          â”‚
â”‚     queue = quote_stream_manager.add_listener()             â”‚
â”‚                                                             â”‚
â”‚     try:                                                    â”‚
â”‚         while True:                                         â”‚
â”‚             # 3. ä»é˜Ÿåˆ—è·å–æ•°æ®                             â”‚
â”‚             quote_data = await queue.get()                  â”‚
â”‚                                                             â”‚
â”‚             # 4. åºåˆ—åŒ–å¹¶å‘é€                               â”‚
â”‚             await websocket.send_text(                      â”‚
â”‚                 json.dumps(quote_data, default=str)         â”‚
â”‚             )                                               â”‚
â”‚                                                             â”‚
â”‚     except WebSocketDisconnect:                             â”‚
â”‚         logger.info("Client disconnected")                  â”‚
â”‚     finally:                                                â”‚
â”‚         # 5. æ¸…ç†ç›‘å¬å™¨                                      â”‚
â”‚         quote_stream_manager.remove_listener(queue)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å‰ç«¯æ¥æ”¶å¹¶å¤„ç†æ•°æ®
```

**é˜Ÿåˆ—æœºåˆ¶**ï¼š
```python
# QuoteStreamManager
class QuoteStreamManager:
    def __init__(self):
        self._ws_listeners: Set[asyncio.Queue] = set()
    
    def add_listener(self) -> asyncio.Queue:
        """æ·»åŠ  WebSocket ç›‘å¬å™¨"""
        queue = asyncio.Queue(maxsize=100)
        self._ws_listeners.add(queue)
        return queue
    
    async def _broadcast(self, quote_data: Dict):
        """å¹¿æ’­åˆ°æ‰€æœ‰ç›‘å¬å™¨"""
        disconnected = []
        for queue in self._ws_listeners.copy():
            try:
                if queue.full():
                    # é˜Ÿåˆ—æ»¡æ—¶ä¸¢å¼ƒæœ€æ—§çš„æ•°æ®
                    try:
                        queue.get_nowait()
                    except asyncio.QueueEmpty:
                        pass
                
                await asyncio.wait_for(
                    queue.put(quote_data),
                    timeout=1.0
                )
            except Exception as e:
                logger.warning(f"Failed to broadcast: {e}")
                disconnected.append(queue)
        
        # æ¸…ç†å¤±è´¥çš„ç›‘å¬å™¨
        for queue in disconnected:
            self._ws_listeners.discard(queue)
```

---

## äº¤æ˜“æ•°æ®æµ

### å®Œæ•´çš„äº¤æ˜“æ‰§è¡Œé“¾è·¯

```
ã€å…¥åœºã€‘
è¡Œæƒ…è§¦å‘ â†’ ç­–ç•¥è¯„ä¼° â†’ é£é™©æ£€æŸ¥ â†’ ä¸‹å•è¯·æ±‚
    â†“
TradingAPI.place_order()
    â†“
Longbridge TradeContext.submit_order()
    â†“
è®¢å•æäº¤æˆåŠŸ
    â†“
    â”œâ”€â†’ åˆ›å»º Position å¯¹è±¡ï¼ˆå†…å­˜ï¼‰
    â”‚       â†“
    â”‚   StrategyEngine.positions[key] = position
    â”‚
    â”œâ”€â†’ å‘é€é€šçŸ¥ï¼ˆå®æ—¶ï¼‰
    â”‚       â†“
    â”‚   NotificationManager.send_order_update()
    â”‚       â†“
    â”‚   WebSocket æ¨é€åˆ°å‰ç«¯
    â”‚
    â””â”€â†’ æ›´æ–°ç­–ç•¥çŠ¶æ€
            â†“
        strategy_status[id] = EXECUTING
        daily_trade_count += 1

ã€æŒä»“ç›‘æ§ã€‘
æŒç»­æ¥æ”¶è¡Œæƒ…
    â†“
PositionMonitor.process_quote(symbol, quote)
    â†“
æ›´æ–° position.current_price
æ›´æ–° position.pnl
    â†“
æ£€æŸ¥å‡ºåœºæ¡ä»¶ï¼š
    â”œâ”€â†’ æ­¢æŸï¼šcurrent_price <= stop_loss
    â”œâ”€â†’ æ­¢ç›ˆï¼šcurrent_price >= take_profit
    â””â”€â†’ ç­–ç•¥ä¿¡å·ï¼ševaluate_strategies()

ã€å‡ºåœºã€‘
è§¦å‘å‡ºåœºæ¡ä»¶
    â†“
StrategyEngine.execute_sell(position, price, reason)
    â†“
TradingAPI.place_order(SELL)
    â†“
Longbridge TradeContext.submit_order()
    â†“
è®¢å•æˆäº¤
    â†“
    â”œâ”€â†’ æ›´æ–° Position å¯¹è±¡
    â”‚       position.exit_price = price
    â”‚       position.exit_time = now
    â”‚       position.pnl = calculated
    â”‚       position.status = "closed"
    â”‚
    â”œâ”€â†’ å‘é€é€šçŸ¥
    â”‚       NotificationManager.send_notification(
    â”‚           type='order_filled',
    â”‚           data={pnl, reason, ...}
    â”‚       )
    â”‚
    â””â”€â†’ æ›´æ–°ç­–ç•¥çŠ¶æ€
            strategy_status[id] = COOLDOWN
            è¿›å…¥å†·å´æœŸï¼ˆé»˜è®¤ 300 ç§’ï¼‰
```

---

## é…ç½®æ•°æ®æµ

### ç›‘æ§é…ç½®æµç¨‹

```
å‰ç«¯ä¿®æ”¹ä»“ä½ç›‘æ§é…ç½®
    â†“
PUT /monitoring/positions/AAPL.US
    â†“
routers/monitoring.py
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. éªŒè¯è¯·æ±‚æ•°æ®                                              â”‚
â”‚    config = PositionMonitoringConfig(**request_body)        â”‚
â”‚                                                             â”‚
â”‚ 2. ä¿å­˜åˆ°æ•°æ®åº“                                              â”‚
â”‚    repositories.save_position_monitoring_config(config)     â”‚
â”‚        â†“                                                    â”‚
â”‚    INSERT OR REPLACE INTO position_monitoring               â”‚
â”‚                                                             â”‚
â”‚ 3. é€šçŸ¥ä»“ä½ç›‘æ§æ›´æ–°                                          â”‚
â”‚    position_monitor = get_position_monitor()                â”‚
â”‚    await position_monitor.update_position_config(           â”‚
â”‚        symbol, config                                       â”‚
â”‚    )                                                        â”‚
â”‚        â†“                                                    â”‚
â”‚    æ›´æ–°å†…å­˜ä¸­çš„ç›‘æ§é…ç½®                                       â”‚
â”‚    monitored_positions[symbol].monitoring_config = config   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
é…ç½®ç«‹å³ç”Ÿæ•ˆ
    â†“
ä¸‹æ¬¡è¡Œæƒ…æ›´æ–°æ—¶åº”ç”¨æ–°é…ç½®
```

---

## ç¼“å­˜ç­–ç•¥

### å¤šå±‚ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€L1 ç¼“å­˜ï¼šå†…å­˜ K çº¿ç¼“å†²åŒºã€‘                                  â”‚
â”‚ StrategyEngine.kline_buffers: Dict[str, KLineBuffer]       â”‚
â”‚                                                             â”‚
â”‚ - æ¯ä¸ª symbol æœ€å¤š 200 æ¡ K çº¿                              â”‚
â”‚ - å®æ—¶æ›´æ–°ï¼ˆè¡Œæƒ…æ¨é€æ—¶ï¼‰                                     â”‚
â”‚ - è¯»å–é€Ÿåº¦ï¼š< 1ms                                            â”‚
â”‚ - å‘½ä¸­ç‡ï¼šé«˜ï¼ˆç­–ç•¥è¯„ä¼°æ—¶ï¼‰                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (ç¼“å­˜æœªå‘½ä¸­)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€L2 ç¼“å­˜ï¼šDuckDB ohlc è¡¨ã€‘                                  â”‚
â”‚ repositories.fetch_candlesticks(symbol, limit)              â”‚
â”‚                                                             â”‚
â”‚ - å†å²åŒæ­¥çš„ K çº¿æ•°æ®                                        â”‚
â”‚ - è¯»å–é€Ÿåº¦ï¼š< 10ms                                           â”‚
â”‚ - æ•°æ®é‡ï¼šæ•°åä¸‡åˆ°æ•°ç™¾ä¸‡æ¡                                   â”‚
â”‚ - å‘½ä¸­ç‡ï¼šä¸­ï¼ˆå†å²æŸ¥è¯¢æ—¶ï¼‰                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (ç¼“å­˜æœªå‘½ä¸­)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€L3 ç¼“å­˜ï¼šDuckDB ticks è¡¨èšåˆã€‘                             â”‚
â”‚ repositories.fetch_bars_from_ticks(symbol, limit)           â”‚
â”‚                                                             â”‚
â”‚ - ä» tick å®æ—¶èšåˆåˆ†é’Ÿçº¿                                     â”‚
â”‚ - è¯»å–é€Ÿåº¦ï¼š< 50ms                                           â”‚
â”‚ - æ•°æ®é‡ï¼šæœ€è¿‘ 3 å¤©çš„ tick                                   â”‚
â”‚ - å‘½ä¸­ç‡ï¼šä½ï¼ˆä»…å½“ ohlc è¡¨ä¸ºç©ºæ—¶ï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (ä»ç„¶æ²¡æœ‰æ•°æ®)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€å›æºï¼šLongbridge APIã€‘                                     â”‚
â”‚ services.sync_candlesticks(symbol)                          â”‚
â”‚                                                             â”‚
â”‚ - è°ƒç”¨ Longbridge API è·å–å†å²æ•°æ®                           â”‚
â”‚ - è¯»å–é€Ÿåº¦ï¼šæ•°ç§’                                             â”‚
â”‚ - æ•°æ®å†™å…¥ DuckDB ohlc è¡¨                                    â”‚
â”‚ - ä¸‹æ¬¡æŸ¥è¯¢å‘½ä¸­ L2 ç¼“å­˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼“å­˜æ›´æ–°ç­–ç•¥

**K çº¿ç¼“å†²åŒºæ›´æ–°**ï¼š
```python
# QuoteStreamManager._on_quote()
await self._dispatch_to_strategy(symbol, quote)
    â†“
# StrategyEngine.process_kline()
market_data = MarketData(
    symbol=symbol,
    open=quote['open'],
    high=quote['high'],
    low=quote['low'],
    close=quote['last_done'],
    volume=quote['volume'],
    timestamp=datetime.now()
)
    â†“
# æ›´æ–°ç¼“å†²åŒº
if symbol not in self.kline_buffers:
    self.kline_buffers[symbol] = KLineBuffer(symbol=symbol)

self.kline_buffers[symbol].add(market_data)
# å¦‚æœè¶…è¿‡ max_sizeï¼ˆ200ï¼‰ï¼Œè‡ªåŠ¨å¼¹å‡ºæœ€æ—§çš„æ•°æ®
```

**æ•°æ®åº“æ›´æ–°**ï¼š
```python
# QuoteStreamManager._persist_tick()
await asyncio.to_thread(
    store_tick_event,
    symbol,
    quote_event
)
    â†“
# repositories.store_tick_event()
INSERT INTO ticks (symbol, ts, price, volume, ...)
VALUES (?, ?, ?, ?, ...)
ON CONFLICT(symbol, ts) DO UPDATE SET ...
# å†²çªæ—¶æ›´æ–°ï¼ˆå¹‚ç­‰æ€§ï¼‰
```

---

## æ€»ç»“

### æ•°æ®æµç‰¹ç‚¹

1. **å®æ—¶æ€§**ï¼š
   - WebSocket æ¨é€ï¼Œå»¶è¿Ÿ < 100ms
   - å†…å­˜ç¼“å†²åŒºï¼Œè¯»å– < 1ms

2. **å¯é æ€§**ï¼š
   - å¤šå±‚ç¼“å­˜ï¼Œé™ä½ API è°ƒç”¨
   - æ•°æ®æŒä¹…åŒ–ï¼Œæ–­ç”µä¸ä¸¢å¤±
   - é”™è¯¯éš”ç¦»ï¼Œå•ä¸ªå¤±è´¥ä¸å½±å“ç³»ç»Ÿ

3. **æ‰©å±•æ€§**ï¼š
   - å¼‚æ­¥å¹¶å‘å¤„ç†
   - é˜Ÿåˆ—æœºåˆ¶æ”¯æŒå¤šå®¢æˆ·ç«¯
   - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•

4. **å®‰å…¨æ€§**ï¼š
   - å‡­æ®åŠ å¯†å­˜å‚¨
   - æœ¬åœ°æ•°æ®åº“ï¼Œæ— å¤–æ³„é£é™©
   - è¾“å…¥éªŒè¯ï¼Œé˜²æ­¢æ³¨å…¥

### å…³é”®è·¯å¾„æ€»ç»“

| è·¯å¾„ | å»¶è¿Ÿ | æ•°æ®æº | ç”¨é€” |
|-----|------|--------|------|
| å®æ—¶è¡Œæƒ…æ¨é€ | < 100ms | Longbridge WebSocket | å‰ç«¯å±•ç¤ºã€ç­–ç•¥è¯„ä¼° |
| å†å² K çº¿æŸ¥è¯¢ | < 10ms | DuckDB (L2) | å›¾è¡¨å±•ç¤º |
| äº¤æ˜“ä¸‹å• | 1-3s | Longbridge API | è‡ªåŠ¨äº¤æ˜“ |
| é…ç½®æ›´æ–° | < 50ms | DuckDB | ç­–ç•¥é…ç½®ã€ç›‘æ§é…ç½® |
| é€šçŸ¥æ¨é€ | < 100ms | WebSocket | å®æ—¶æé†’ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2024-10-03  
**ç»´æŠ¤è€…**: Longbridge Quant Team

