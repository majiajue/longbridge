# 智能仓位管理系统使用指南

## 功能概述

智能仓位管理系统可以根据您的账户资金、现有持仓和风险偏好，自动计算合理的买卖数量，并为新增股票自动生成交易策略。

### 核心功能

1. **单个仓位计算** - 为单只股票计算最优买卖数量
2. **批量策略生成** - 为多只股票一次性计算仓位并创建策略
3. **资金管理** - 基于可用资金自动调整仓位大小
4. **风险控制** - 自动计算止损止盈价格
5. **持仓分析** - 实时显示组合状态和资金使用情况

## 访问路径

启动系统后，访问：http://localhost:8000

点击顶部导航的 **"智能仓位"** 标签 🎲

## 一、账户概览

页面顶部显示您的账户状态：

- **总资产** - 现金 + 持仓市值
- **可用资金** - 可用于新交易的现金
- **持仓市值** - 当前所有持仓的总市值
- **现金比例** - 现金占总资产的比例

## 二、单个仓位计算

### 适用场景
- 想买入一只新股票，但不知道买多少
- 想卖出部分持仓，需要计算数量
- 评估某个交易的风险大小

### 使用步骤

#### 1. 填写基本信息

**股票代码**
- 输入完整的股票代码
- 例如：`700.HK` (腾讯), `AAPL.US` (苹果)

**操作类型**
- `买入` - 计算新买入的数量
- `卖出` - 计算卖出现有持仓的数量

#### 2. 选择计算方法

系统提供 4 种计算方法：

##### 方法 1：资金百分比（推荐）
- 根据总资产的百分比计算仓位
- 适合：均衡配置，分散风险
- 示例：总资产 $100,000，配置 10%，则投入 $10,000

##### 方法 2：基于风险
- 根据可承受的最大损失计算仓位
- 适合：严格风险控制
- 示例：愿意冒 $2,000 的风险，止损 5%，则可买入 $40,000 仓位

##### 方法 3：固定金额
- 使用固定的金额买入
- 适合：有明确资金计划
- 示例：每次固定投入 $10,000

##### 方法 4：等权重
- 假设持有 N 个股票，每个股票平均分配资金
- 适合：指数化投资
- 示例：计划持有 5 只股票，则每只 20%

#### 3. 设置参数

**目标仓位比例** (0.01 - 1.0)
- 该股票占总资产的目标比例
- 默认：0.1 (10%)
- 建议：
  - 保守投资：5-10%
  - 中等风险：10-15%
  - 激进投资：15-20%

**止损比例** (0.01 - 0.5)
- 当价格下跌达到该比例时止损
- 默认：0.05 (5%)
- 建议：
  - 短线交易：3-5%
  - 中线持有：5-8%
  - 长线投资：8-10%

#### 4. 查看计算结果

点击"计算"后，系统会显示：

```
操作：买入
数量：100 股
预估价格：$150.50
预估成本：$15,050.00
风险等级：低风险
建议止损：$143.00
建议止盈：$165.00
说明：根据可用资金 $50,000 调整数量
```

**结果解读：**

- **数量** - 建议买入/卖出的股数
- **预估成本** - 需要的资金（买入时为正，卖出时为负）
- **风险等级** - 根据最大损失占总资产的比例评估
  - 低风险：< 1%
  - 中风险：1-2%
  - 高风险：> 2%
- **建议止损** - 自动计算的止损价格
- **建议止盈** - 自动计算的止盈价格（通常为止损的3倍）
- **说明** - 计算逻辑的解释

### 智能调整机制

系统会自动根据资金情况调整：

1. **资金不足时**
   - 自动调整数量以适应可用资金
   - 保留 10% 缓冲以应对手续费

2. **已有持仓时**
   - 卖出时：只计算可卖数量
   - 买入时：提示已有持仓

3. **价格异常时**
   - 无法获取价格时提示错误
   - 确保至少买入 1 股

## 三、批量策略生成

### 适用场景
- 新增多只股票到监控列表
- 根据持仓情况批量创建策略
- 快速建立多元化投资组合

### 使用步骤

#### 1. 点击"新建批量任务"

#### 2. 填写股票列表
```
700.HK, AAPL.US, TSLA.US, NVDA.US
```
- 用逗号分隔多个股票代码
- 支持港股（.HK）和美股（.US）
- 可以一次输入 10-20 只股票

#### 3. 选择策略类型

**均线交叉策略**
- 基于 5 日和 20 日均线
- 黄金交叉买入，死亡交叉卖出
- 适合：趋势明显的市场

**RSI 超卖反弹策略**
- RSI < 30 时买入
- RSI > 70 时卖出
- 适合：震荡市场

#### 4. 设置配置比例

**每个股票的配置比例** (0.01 - 1.0)
- 每只股票占总资产的比例
- 默认：0.1 (10%)
- 建议：
  - 4-5 只股票：15-20% 每只
  - 6-8 只股票：10-15% 每只
  - 9-10 只股票：8-10% 每只

#### 5. 查看批量结果

系统会为每只股票显示：

| 股票 | 建议数量 | 预估成本 | 风险 | 状态 |
|------|---------|---------|------|------|
| 700.HK | 100 | $15,000 | 低风险 | 需创建策略 |
| AAPL.US | 50 | $8,500 | 低风险 | 已有持仓 |
| TSLA.US | 30 | $6,300 | 中风险 | 需创建策略 |

**状态说明：**
- **需创建策略** - 该股票没有持仓，系统已自动创建策略（禁用状态）
- **已有持仓** - 该股票已有持仓，不需要创建新策略

#### 6. 启用策略

批量生成的策略默认处于 **禁用** 状态，需要手动启用：

1. 切换到"策略控制"页面
2. 找到自动生成的策略（名称以"自动策略"开头）
3. 检查配置是否合理
4. 打开策略开关启用

## 四、实际操作示例

### 示例 1：新手投资者买入第一只股票

**场景：** 账户有 $10,000，想买腾讯股票

**步骤：**
1. 输入股票代码：`700.HK`
2. 操作类型：买入
3. 计算方法：资金百分比
4. 目标仓位：0.2 (20% 即 $2,000)
5. 止损比例：0.05 (5%)
6. 点击"计算"

**结果：**
```
建议买入：4 股
预估成本：$1,920
风险：低
止损价：$456
止盈价：$528
```

### 示例 2：持有多只股票的投资者调整仓位

**场景：** 已持有 AAPL, 想增加持仓 50%

**步骤：**
1. 输入：`AAPL.US`
2. 操作类型：买入
3. 计算方法：基于风险
4. 最大风险：0.02 (2%)
5. 点击"计算"

**结果：**
系统会基于当前持仓计算增量买入数量

### 示例 3：建立多元化投资组合

**场景：** $50,000，想投资 5 只科技股

**步骤：**
1. 点击"新建批量任务"
2. 输入：`AAPL.US, MSFT.US, GOOGL.US, NVDA.US, TSLA.US`
3. 策略类型：均线交叉
4. 配置比例：0.15 (每只 15%)
5. 点击"生成"

**结果：**
- 系统为每只股票计算仓位
- 自动创建 5 个策略（禁用状态）
- 在策略控制页面启用需要的策略

## 五、风险管理

### 全局限制

系统内置保护机制：

```python
{
  "max_daily_trades": 10,          # 每日最多 10 笔交易
  "max_total_positions": 5,        # 全局最多 5 个持仓
  "max_risk_per_trade": 0.02,      # 单笔最大风险 2%
  "cooldown_period": 300           # 交易后 5 分钟冷却
}
```

### 仓位控制建议

1. **总仓位**
   - 保守：50-60% (留 40-50% 现金)
   - 平衡：70-80%
   - 激进：80-90%

2. **单个股票**
   - 不超过总资产的 20%
   - 高风险股票 < 10%

3. **行业集中度**
   - 同一行业不超过 40%
   - 至少分布在 3 个行业

### 风险等级说明

- **低风险** (绿色)
  - 最大损失 < 1% 总资产
  - 适合保守投资者
  - 建议：大部分仓位

- **中风险** (黄色)
  - 最大损失 1-2% 总资产
  - 适合平衡投资者
  - 建议：部分仓位

- **高风险** (红色)
  - 最大损失 > 2% 总资产
  - 适合激进投资者
  - 建议：小部分仓位或避免

## 六、常见问题

### Q1: 计算出来的数量太少怎么办？

**原因：**
- 可用资金不足
- 目标仓位比例太小
- 股价太高

**解决：**
- 增加目标仓位比例
- 选择价格较低的股票
- 增加账户资金

### Q2: 为什么显示"已有持仓"？

系统检测到该股票已有持仓，建议：
- 如需增仓，调整计算方法
- 如需减仓，选择"卖出"操作
- 在策略控制页面管理现有策略

### Q3: 批量生成的策略在哪里？

1. 切换到"策略控制"页面
2. 查找以"自动策略 - XXX"命名的策略
3. 这些策略默认禁用，需手动启用

### Q4: 能否修改自动生成的策略？

可以，在策略控制页面：
1. 找到对应策略
2. 点击设置图标
3. 修改监控标的等参数
4. 保存更改

### Q5: 计算结果只是建议吗？

是的，计算结果仅作为参考：
- 您可以根据实际情况调整
- 系统不会自动执行交易
- 需要在策略控制页面启用策略后才会交易

## 七、API 接口

如果需要通过程序调用：

### 计算单个仓位
```bash
POST /position-manager/calculate
Content-Type: application/json

{
  "symbol": "700.HK",
  "action": "buy",
  "method": "percentage",
  "target_allocation": 0.1,
  "max_risk": 0.02,
  "stop_loss_pct": 0.05
}
```

### 批量生成策略
```bash
POST /position-manager/auto-strategy
Content-Type: application/json

{
  "symbols": ["700.HK", "AAPL.US"],
  "strategy_type": "ma_crossover",
  "allocation_per_symbol": 0.1,
  "auto_execute": false
}
```

### 获取组合状态
```bash
GET /position-manager/portfolio-status
```

## 八、最佳实践

### 1. 新手入门

第一步：小仓位试水
- 每只股票配置 5-10%
- 使用"资金百分比"方法
- 设置较大的止损（8-10%）

第二步：逐步增加
- 观察策略表现
- 根据盈亏调整比例
- 学习风险控制

### 2. 进阶使用

**分散投资**
- 至少 5-8 只股票
- 覆盖不同行业
- 港股 + 美股组合

**动态调整**
- 定期（每月）重新计算
- 根据市场情况调整仓位
- 盈利股票适当止盈

### 3. 高级技巧

**配对交易**
- 同时买入相关股票
- 一只做多，一只做空
- 降低系统性风险

**分批建仓**
- 将目标仓位分 3-5 次建立
- 每次间隔 1-2 周
- 降低择时风险

## 九、与其他功能的配合

### 与策略控制配合

1. 智能仓位计算 → 确定买卖数量
2. 策略控制 → 创建和启用策略
3. 持仓监控 → 跟踪执行效果

### 与持仓K线配合

1. 查看持仓K线图
2. 判断是否需要调整仓位
3. 使用智能仓位重新计算

### 工作流程

```
1. 智能仓位 → 计算合理数量
         ↓
2. 策略控制 → 创建并启用策略
         ↓
3. 持仓监控 → 实时跟踪表现
         ↓
4. 持仓K线 → 技术分析
         ↓
5. 智能仓位 → 调整仓位（循环）
```

## 十、注意事项

### ⚠️ 重要提醒

1. **仅供参考**
   - 计算结果基于数学模型
   - 不构成投资建议
   - 需结合实际情况判断

2. **市场风险**
   - 股市有风险，投资需谨慎
   - 历史表现不代表未来
   - 设置合理的止损

3. **资金安全**
   - 不要满仓操作
   - 预留应急资金
   - 分散投资降低风险

4. **系统限制**
   - 计算基于当前价格
   - 实际成交价可能不同
   - 需考虑交易成本（手续费、税费）

## 相关文档

- [策略创建指南](./STRATEGY_CREATION_GUIDE.md)
- [策略控制指南](./STRATEGIES_GUIDE.md)
- [持仓监控指南](./POSITION_KLINES_GUIDE.md)
- [风险管理](./ERROR_HANDLING.md)

---

**版本**: v1.0.0  
**更新日期**: 2025-01-22  
**状态**: ✅ 稳定版本

















