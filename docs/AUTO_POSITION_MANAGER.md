# 自动仓位管理系统

## 概述

自动仓位管理系统能够自动识别持仓，智能决策买卖操作，实现持仓的自动化管理。系统结合规则引擎和AI分析，为用户提供7x24小时的持仓监控服务。

## 功能特性

### 1. 自动持仓监控
- ✅ 定期扫描所有持仓（默认30分钟）
- ✅ 实时计算盈亏状态
- ✅ 自动识别风险机会

### 2. 智能决策引擎
**规则引擎（默认启用）**
- 自动止损：持仓跌幅达到阈值（默认-5%）时自动卖出
- 自动止盈：持仓涨幅达到阈值（默认+15%）时自动卖出
- 自动补仓：持仓跌幅较大（默认-10%）且未达到最大仓位时考虑补仓

**AI分析引擎（可选）**
- 集成 DeepSeek AI 分析
- 综合技术指标和市场形态
- 提供信心度评分
- 需要配置 DeepSeek API Key

### 3. 风险管理
- 单个持仓最大市值限制
- 补仓比例控制
- 卖出比例可配置
- 模拟模式保护（默认开启）

### 4. 交易记录
- 完整的决策日志
- 模拟交易记录
- 盈亏追踪
- 操作原因说明

## 使用指南

### 步骤1: 配置参数

1. 进入「智能仓位」页面
2. 找到「自动仓位管理」面板
3. 点击「⚙️ 配置」按钮
4. 设置以下参数：

**基础设置**
- **检查间隔**：建议30-60分钟
- **卖出比例**：1.0 = 全部卖出，0.5 = 卖出一半

**风险管理参数**
- **自动止损（%）**：默认 -5.0%，建议 -3% ~ -10%
- **自动止盈（%）**：默认 +15.0%，建议 +10% ~ +30%
- **补仓触发（%）**：默认 -10.0%，建议 -8% ~ -15%
- **最大单个持仓（$）**：默认 $50,000
- **补仓比例**：默认 5%总资产

**AI 分析设置**
- **启用 AI 分析**：是/否
- **AI 最小信心度**：默认 0.7，建议 >= 0.7

**高级设置**
- **启用真实交易**：默认关闭（模拟模式）

### 步骤2: 配置 AI（可选）

如果启用 AI 分析：
1. 前往「⚙️ 基础配置」页面
2. 找到「AI 配置」区域
3. 输入 DeepSeek API Key
4. 点击「保存 AI 配置」

### 步骤3: 启动自动管理

1. 在「智能仓位」页面
2. 点击绿色「启动」按钮
3. 系统开始自动监控所有持仓

### 步骤4: 监控运行状态

**状态指示器**
- 🟢 运行中：系统正在监控
- ⚪ 已停止：系统未运行

**实时统计**
- 今日交易次数
- 检查间隔时间

**交易记录**
- 自动显示最近的决策和模拟交易
- 包含操作类型、股票、数量、价格、原因

## 决策逻辑详解

### 1. 自动卖出条件

系统在以下情况下会执行卖出操作：

**止损触发**
```
当前盈亏 % <= 自动止损阈值
```
示例：持仓成本$100，当前价格$95，盈亏 -5%
- 如果止损设置为 -5%，触发卖出

**止盈触发**
```
当前盈亏 % >= 自动止盈阈值
```
示例：持仓成本$100，当前价格$115，盈亏 +15%
- 如果止盈设置为 +15%，触发卖出

**AI 建议卖出**（启用AI时）
```
AI action = 'SELL' AND confidence >= 最小信心度
```

### 2. 自动补仓条件

**补仓触发**
```
当前盈亏 % <= 补仓触发阈值
AND 当前市值 < 最大持仓限制
```
示例：持仓成本$10,000，当前价值$9,000，盈亏 -10%
- 如果补仓触发设置为 -10%，考虑补仓
- 补仓金额 = 总资产 × 补仓比例

**AI 建议买入**（启用AI时）
```
AI action = 'BUY' AND confidence >= 最小信心度
```

### 3. 决策优先级

1. **止损**：最高优先级，立即执行
2. **止盈**：次高优先级，获利了结
3. **AI 分析**：综合判断
4. **补仓**：谨慎执行

## 安全机制

### 1. 模拟模式（默认）
- 所有决策仅记录，不执行真实交易
- 可以观察系统表现
- 适合参数调优

### 2. 真实交易模式
- ⚠️ 需要手动开启
- 会执行真实的买卖操作
- 建议充分测试后再启用
- 目前需要集成 Longbridge Trading API

### 3. 配置验证
- 参数范围限制
- 最小间隔保护
- 资金充足性检查

## API 接口

### 启动自动管理
```http
POST /position-manager/auto/start
```

### 停止自动管理
```http
POST /position-manager/auto/stop
```

### 获取运行状态
```http
GET /position-manager/auto/status
```

### 更新配置
```http
PUT /position-manager/auto/config
Content-Type: application/json

{
  "enabled": true,
  "check_interval_minutes": 30,
  "use_ai_analysis": true,
  "auto_stop_loss_percent": -5.0,
  "auto_take_profit_percent": 15.0,
  ...
}
```

### 获取交易记录
```http
GET /position-manager/auto/trades?limit=50
```

## 最佳实践

### 1. 参数设置建议

**保守型**
- 止损：-3%
- 止盈：+10%
- 补仓触发：-8%
- 检查间隔：60分钟

**平衡型**（默认）
- 止损：-5%
- 止盈：+15%
- 补仓触发：-10%
- 检查间隔：30分钟

**激进型**
- 止损：-8%
- 止盈：+20%
- 补仓触发：-15%
- 检查间隔：15分钟

### 2. 使用流程

1. **测试阶段**（1-2周）
   - 使用模拟模式
   - 观察决策质量
   - 调整参数

2. **优化阶段**（1-2周）
   - 根据市场情况微调参数
   - 评估盈亏表现
   - 记录经验

3. **上线阶段**
   - 小仓位试运行
   - 逐步增加仓位
   - 持续监控

### 3. 风险控制

✅ **建议做法**
- 从模拟模式开始
- 设置合理的止损止盈
- 定期检查交易记录
- 根据市场调整参数

❌ **不建议做法**
- 直接启用真实交易
- 设置过大的止损范围
- 不监控运行状态
- 忽略AI信心度

## 技术架构

### 后端

**核心引擎**
```
backend/app/auto_position_manager.py
- AutoPositionManager: 主引擎类
- _run_loop(): 监控循环
- _make_decision(): 决策逻辑
```

**API 路由**
```
backend/app/routers/position_manager.py
- /auto/start: 启动
- /auto/stop: 停止
- /auto/status: 状态
- /auto/config: 配置
- /auto/trades: 记录
```

**数据表**
```sql
-- 配置表
auto_position_config (id, enabled, check_interval_minutes, ...)

-- 交易记录表
auto_position_trades (id, timestamp, action, symbol, quantity, price, ...)
```

### 前端

**页面组件**
```
frontend/src/pages/SmartPosition.tsx
- 自动管理控制面板
- 配置对话框
- 交易记录表格
```

## 故障排查

### 问题1: 启动失败

**可能原因**
- 配置未启用
- DeepSeek API Key 未配置（如启用AI）
- 数据库连接问题

**解决方法**
1. 检查配置是否启用
2. 确认 API Key 配置正确
3. 查看后端日志

### 问题2: 没有执行交易

**可能原因**
- 模拟模式启用
- 没有满足决策条件
- 信心度不足（AI模式）

**解决方法**
1. 查看交易记录中的"跳过原因"
2. 检查当前盈亏是否达到阈值
3. 降低AI信心度要求（如启用）

### 问题3: 交易过于频繁

**可能原因**
- 检查间隔太短
- 参数设置过于敏感

**解决方法**
1. 增加检查间隔
2. 适当扩大止损止盈范围

## 未来计划

- [ ] 真实交易API集成
- [ ] 更多技术指标支持
- [ ] 多账户管理
- [ ] 策略回测功能
- [ ] 性能报告生成
- [ ] 移动端推送通知

## 参考资料

- [智能仓位管理功能说明.md](../智能仓位管理功能说明.md)
- [AI Trading Guide](./AI_TRADING_GUIDE.md)
- [Position Calculator](../backend/app/position_calculator.py)
- [Auto Position Manager](../backend/app/auto_position_manager.py)



