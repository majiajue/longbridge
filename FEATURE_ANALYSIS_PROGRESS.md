# æ™ºèƒ½é€‰è‚¡åˆ†æè¿›åº¦æ¡åŠŸèƒ½

## âœ¨ æ–°å¢åŠŸèƒ½

åœ¨æ™ºèƒ½é€‰è‚¡åˆ†ææ—¶ï¼Œæ·»åŠ äº†**å®æ—¶è¿›åº¦æ¡**ï¼Œæ˜¾ç¤ºå½“å‰åˆ†æè¿›åº¦å’Œæ­£åœ¨åˆ†æçš„è‚¡ç¥¨ã€‚

## ğŸ¨ ç•Œé¢æ•ˆæœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ†æè¿›åº¦                          âœ•    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ­£åœ¨åˆ†æ: AAPL           15 / 20       â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  75%          â”‚
â”‚                                         â”‚
â”‚  è¯¦ç»†æ—¥å¿—ï¼š                             â”‚
â”‚  å¼€å§‹åˆ†æ 20 åªè‚¡ç¥¨...                  â”‚
â”‚  æ­£åœ¨åˆ†æ: AAPL                         â”‚
â”‚  å®Œæˆ: AAPL (15/20)                     â”‚
â”‚  æ­£åœ¨åˆ†æ: TSLA                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ˜¾ç¤ºå†…å®¹

1. **å½“å‰åˆ†æè‚¡ç¥¨** - æ˜¾ç¤ºæ­£åœ¨åˆ†æå“ªåªè‚¡ç¥¨ä»£ç 
2. **è¿›åº¦æ•°å­—** - æ˜¾ç¤º "å®Œæˆæ•° / æ€»æ•°"ï¼ˆå¦‚ 15 / 20ï¼‰
3. **è¿›åº¦æ¡** - å¯è§†åŒ–æ˜¾ç¤ºå®Œæˆç™¾åˆ†æ¯”
4. **ç™¾åˆ†æ¯”** - ç²¾ç¡®æ˜¾ç¤ºå®Œæˆç™¾åˆ†æ¯”ï¼ˆå¦‚ 75%ï¼‰
5. **è¯¦ç»†æ—¥å¿—** - æ»šåŠ¨æ˜¾ç¤ºåˆ†ææ—¥å¿—

## ğŸ¯ å®ç°åŸç†

### åç«¯ SSE æ¨é€

```python
# backend/app/routers/stock_picker.py
@router.get("/analysis/progress")
async def get_analysis_progress():
    """å®æ—¶æ¨é€åˆ†æè¿›åº¦"""
    async def event_generator():
        while True:
            progress_data = {
                'current': 'å½“å‰è‚¡ç¥¨ä»£ç ',
                'total': æ€»æ•°é‡,
                'completed': å·²å®Œæˆæ•°é‡,
                'status': 'idle' | 'running' | 'completed',
                'logs': ['æ—¥å¿—1', 'æ—¥å¿—2', ...]
            }
            yield f"data: {json.dumps(progress_data)}\n\n"
            
            if progress_data['status'] == 'completed':
                break
            
            await asyncio.sleep(0.5)
```

### å‰ç«¯ EventSource æ¥æ”¶

```typescript
// frontend/src/pages/StockPicker.tsx
const eventSource = new EventSource(`${API_BASE}/api/stock-picker/analysis/progress`);

eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  
  // æ›´æ–°è¿›åº¦æ¡
  setAnalysisProgress({
    current: data.current,      // å½“å‰è‚¡ç¥¨
    total: data.total,          // æ€»æ•°
    completed: data.completed,  // å·²å®Œæˆ
    status: data.status,        // çŠ¶æ€
  });
  
  // æ›´æ–°æ—¥å¿—
  setAnalysisLogs(data.logs);
};
```

## ğŸš€ ä½¿ç”¨æ–¹å¼

1. **æ‰“å¼€ Stock Picker é¡µé¢**
2. **æ·»åŠ è‚¡ç¥¨åˆ° LONG æˆ– SHORT æ± **
3. **ç‚¹å‡»ã€Œå¼€å§‹åˆ†æã€æŒ‰é’®**
4. **è§‚å¯Ÿè¿›åº¦æ¡**ï¼š
   - å®æ—¶æ˜¾ç¤ºæ­£åœ¨åˆ†æçš„è‚¡ç¥¨
   - è¿›åº¦æ¡åŠ¨æ€æ›´æ–°
   - æ—¥å¿—æ»šåŠ¨æ˜¾ç¤º
5. **å®Œæˆå**ï¼šæ˜¾ç¤ºç»¿è‰²å®Œæˆæç¤º

## ğŸ“± ç•Œé¢çŠ¶æ€

### çŠ¶æ€ 1ï¼šå‡†å¤‡ä¸­
```
æ­£åœ¨åˆ†æ: å‡†å¤‡ä¸­...        0 / 20
â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  0%
```

### çŠ¶æ€ 2ï¼šåˆ†æä¸­
```
æ­£åœ¨åˆ†æ: AAPL             8 / 20
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  40%

è¯¦ç»†æ—¥å¿—ï¼š
å¼€å§‹åˆ†æ 20 åªè‚¡ç¥¨...
æ­£åœ¨åˆ†æ: AAPL
å®Œæˆ: AAPL (8/20)
```

### çŠ¶æ€ 3ï¼šå®Œæˆ
```
âœ… åˆ†æå®Œæˆï¼å…±åˆ†æ 20 åªè‚¡ç¥¨

è¯¦ç»†æ—¥å¿—ï¼š
âœ… åˆ†æå®Œæˆ: æˆåŠŸ 18, è·³è¿‡ 2, å¤±è´¥ 0
```

## ğŸ¨ æ ·å¼ç‰¹ç‚¹

1. **å¹³æ»‘åŠ¨ç”»** - è¿›åº¦æ¡ä½¿ç”¨ CSS transitionï¼Œå¹³æ»‘è¿‡æ¸¡
2. **é¢œè‰²ç¼–ç **ï¼š
   - è“è‰²è¿›åº¦æ¡ - åˆ†æä¸­
   - ç»¿è‰²æç¤º - å®Œæˆ
   - ç°è‰²èƒŒæ™¯ - æ—¥å¿—åŒºåŸŸ
3. **è‡ªåŠ¨æ»šåŠ¨** - æ—¥å¿—åŒºåŸŸè‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°
4. **å“åº”å¼** - é€‚é…ä¸åŒå±å¹•å°ºå¯¸

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### 1. SSE (Server-Sent Events)

- åè®®ï¼š`text/event-stream`
- é—´éš”ï¼š0.5ç§’æ¨é€ä¸€æ¬¡
- è‡ªåŠ¨é‡è¿ï¼šè¿æ¥æ–­å¼€åè‡ªåŠ¨é‡è¿

### 2. è¿›åº¦è®¡ç®—

```typescript
const percentage = (completed / total) * 100;
```

### 3. çŠ¶æ€ç®¡ç†

```typescript
const [analysisProgress, setAnalysisProgress] = useState({
  current: '',           // å½“å‰è‚¡ç¥¨ä»£ç 
  total: 0,             // æ€»æ•°
  completed: 0,         // å·²å®Œæˆ
  status: 'idle',       // idle | running | completed
});
```

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šè¿›åº¦æ¡ä¸æ˜¾ç¤º

**åŸå› **ï¼šSSE è¿æ¥å¤±è´¥æˆ–åç«¯æœªæ¨é€æ•°æ®

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥åç«¯æ—¥å¿—
tail -f logs/backend.log | grep "åˆ†æ"

# æ£€æŸ¥ SSE ç«¯ç‚¹
curl http://localhost:8000/api/stock-picker/analysis/progress
```

### é—®é¢˜2ï¼šè¿›åº¦åœæ»

**åŸå› **ï¼šæŸåªè‚¡ç¥¨åˆ†æå¡ä½

**è§£å†³**ï¼š
```python
# backend/app/stock_picker.py
# æ·»åŠ è¶…æ—¶å¤„ç†
async def analyze_with_limit(stock, ptype):
    try:
        async with asyncio.timeout(60):  # 60ç§’è¶…æ—¶
            result = await self._analyze_single_stock(...)
    except asyncio.TimeoutError:
        logger.error(f"åˆ†æè¶…æ—¶: {symbol}")
```

### é—®é¢˜3ï¼šè¿›åº¦ç™¾åˆ†æ¯”ä¸å‡†ç¡®

**åŸå› **ï¼š`completed` æ›´æ–°ä¸åŠæ—¶

**è§£å†³**ï¼šç¡®ä¿æ¯æ¬¡åˆ†æå®Œæˆåç«‹å³æ›´æ–°ï¼š
```python
completed_count += 1
progress_callback({
    'completed': completed_count,
    'log': f'å®Œæˆ: {symbol} ({completed_count}/{total_count})'
})
```

## ğŸ¯ æœªæ¥æ”¹è¿›

- [ ] æ·»åŠ ä¼°è®¡å‰©ä½™æ—¶é—´ï¼ˆETAï¼‰
- [ ] æ˜¾ç¤ºæ¯åªè‚¡ç¥¨çš„åˆ†æè€—æ—¶
- [ ] æ·»åŠ æš‚åœ/æ¢å¤åŠŸèƒ½
- [ ] æ”¯æŒåå°åˆ†æï¼ˆå…³é—­å¼¹çª—åç»§ç»­ï¼‰
- [ ] æ·»åŠ åˆ†æé€Ÿåº¦ç»Ÿè®¡ï¼ˆè‚¡/ç§’ï¼‰

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `frontend/src/pages/StockPicker.tsx` - å‰ç«¯è¿›åº¦æ¡ç•Œé¢
- `backend/app/routers/stock_picker.py` - SSE ç«¯ç‚¹
- `backend/app/stock_picker.py` - åˆ†æé€»è¾‘å’Œè¿›åº¦å›è°ƒ

---

**ç‰ˆæœ¬**ï¼šV1.0
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-03
**ä½œè€…**ï¼šAI Trading Team
