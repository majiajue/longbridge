# 持仓K线快速上手 🚀

## 已完成的功能

✅ **持仓K线页面**
- 自动加载所有持仓股票
- 专业K线图表（使用 Lightweight Charts）
- 多周期切换（日线/周线/月线/分时）
- 显示盈亏信息
- 一键切换查看不同股票

✅ **自动数据同步**
- 后端启动时自动同步持仓股票K线数据
- 无需手动操作

✅ **错误修复**
- 修复了 `toFixed()` 的 undefined 错误
- 添加了安全的空值检查

---

## 快速使用

### 1. 确保服务运行中

```bash
# 检查后端
curl http://localhost:8000/health
# 应该返回: {"status":"ok"}

# 检查前端
curl http://localhost:5173
# 应该返回 HTML 页面
```

### 2. 访问持仓K线

1. 打开浏览器：`http://localhost:5173`
2. 点击顶部导航 **"持仓K线 📊"** 标签
3. 等待加载（第一次可能需要几秒）

### 3. 查看K线图

**界面说明：**

```
左侧：持仓股票列表
- 显示所有持仓股票
- 绿色：盈利
- 红色：亏损
- 点击切换

右侧：K线图表
- 顶部：股票信息 + 盈亏
- 中间：专业K线图
- 右上角：周期切换
```

### 4. 切换周期

点击右上角的"周期"下拉菜单：
- 📊 **日线**：适合中长期分析
- 📈 **周线**：适合波段操作
- 📉 **月线**：适合长期投资
- ⏱️ **分时**：1/5/15/60分钟，适合短线

---

## 当前状态

### ✅ 已实现

| 功能 | 状态 | 说明 |
|------|------|------|
| 持仓列表加载 | ✅ | 自动获取所有持仓 |
| K线图表显示 | ✅ | 专业图表库 |
| 多周期切换 | ✅ | 7种周期可选 |
| 盈亏信息 | ✅ | 实时显示 |
| 数据自动同步 | ✅ | 后台启动时同步 |
| 错误处理 | ✅ | 安全空值检查 |

### 📊 测试数据

**当前持仓：14只股票**
```
✅ JD.US - 已同步100条K线
✅ TSLL.US - 已同步100条K线
✅ YANG.US - 已同步100条K线
✅ UMC.US - 已同步100条K线
... 等等
```

---

## 页面布局

```
┌────────────────────────────────────────────────────────────┐
│  持仓K线图表                        [14 只持仓] [刷新]      │
│  查看持仓股票的历史K线走势                                  │
└────────────────────────────────────────────────────────────┘

┌──────────┬─────────────────────────────────────────────────┐
│          │  JD.US - JD.com                                 │
│ 持仓列表  │  持仓: 18股 | 成本: $33.06 | +$4.14 (+0.65%)   │
│          │  ┌────────────────────────────────┐  [周期 ▼]  │
│ ┌──────┐ │  │                                │   日线      │
│ │JD.US │◄┼──┤     K线图表（可缩放拖动）       │             │
│ │+0.65%│ │  │                                │             │
│ └──────┘ │  └────────────────────────────────┘             │
│          │  共 100根K线 | 最早-最新日期                    │
│ ┌──────┐ │                                                 │
│ │TSLL  │ │                                                 │
│ │+1.2% │ │                                                 │
│ └──────┘ │                                                 │
└──────────┴─────────────────────────────────────────────────┘
```

---

## 与其他功能的关系

### 🎯 策略盯盘 → 持仓K线

**使用场景：**
1. 在"策略盯盘"看到买入信号
2. 切换到"持仓K线"查看图表
3. 确认K线形态
4. 决定是否执行交易

### 👁️ 持仓监控 → 持仓K线

**使用场景：**
1. 收到止损预警
2. 切换到"持仓K线"分析原因
3. 判断是短期回调还是趋势反转
4. 决定补仓或止损

### 📈 完整工作流

```
1. 持仓K线（看图表）
   └─ 了解走势，判断趋势

2. 策略盯盘（看信号）
   └─ 获取买卖建议

3. 持仓监控（看风险）
   └─ 检查止损止盈

4. 策略控制（执行交易）
   └─ 下单买卖
```

---

## 技术特点

### 前端技术
- **React + TypeScript**：类型安全
- **Material-UI**：美观的UI组件
- **Lightweight Charts**：专业金融图表库
- **响应式设计**：自适应窗口大小

### 后端支持
- **FastAPI**：高性能API
- **DuckDB**：快速数据查询
- **自动同步**：启动时同步数据

### 数据流
```
后端启动
    ↓
自动同步持仓K线（100条/股）
    ↓
存入 DuckDB（ohlc表）
    ↓
前端调用 /portfolio/overview
    ↓
前端调用 /quotes/history
    ↓
Lightweight Charts 绘制
```

---

## 故障排查

### 问题1：页面显示"暂无持仓股票"

**原因：**
- ACCESS_TOKEN 无效或过期

**解决：**
1. 进入"基础配置"
2. 更新 ACCESS_TOKEN
3. 重启后端服务

### 问题2：股票没有K线数据

**原因：**
- 新买入的股票还未同步
- 数据库中确实没有数据

**解决：**
1. 重启后端（会自动同步）
2. 或手动在"历史K线"页面同步

### 问题3：图表显示空白

**原因：**
- K线数据不足30条
- 图表容器未正确渲染

**解决：**
1. 刷新页面
2. 切换其他股票再切回来

---

## 下一步优化方向

### 📈 技术指标（计划中）
- [ ] 添加移动平均线（MA5/10/20/60）
- [ ] 添加成交量柱状图
- [ ] 添加 MACD 指标
- [ ] 添加 RSI 指标
- [ ] 添加布林带

### 🎨 UI增强（计划中）
- [ ] 添加K线数据详情悬浮框
- [ ] 添加快捷键支持
- [ ] 添加图表截图功能
- [ ] 添加全屏模式

### 🔔 功能扩展（计划中）
- [ ] 标记买卖点
- [ ] 价格预警线
- [ ] 历史交易记录叠加
- [ ] 策略信号叠加显示

---

## 总结

### ✅ 当前可用
1. ✅ 自动加载持仓股票
2. ✅ 专业K线图表显示
3. ✅ 多周期切换（7种）
4. ✅ 盈亏信息整合
5. ✅ 数据自动同步
6. ✅ 错误安全处理

### 🎯 使用价值
1. **省时间**：不用去其他平台查K线
2. **更直观**：盈亏信息 + K线图表一起看
3. **更专业**：使用金融级图表库
4. **更方便**：一键切换所有持仓股票

---

**立即体验：**
1. 访问：`http://localhost:5173`
2. 点击：**"持仓K线 📊"**
3. 开始分析你的持仓！

📊 祝交易顺利！✨




















